# ä»»åŠ¡è¿›åº¦æ˜¾ç¤ºç¤ºä¾‹

# RunningHub AI åº”ç”¨ä»»åŠ¡è¿›åº¦æ˜¾ç¤ºè„šæœ¬ä½¿ç”¨æ‰‹å†Œ

## ä¸€ã€å·¥å…·ç®€ä»‹

æœ¬è„šæœ¬æ˜¯ä¸€ä¸ªç”¨äºç›‘æ§ Runninghub å¹³å°ä¸Šä»»åŠ¡è¿›åº¦çš„å·¥å…·ã€‚é€šè¿‡è„šæœ¬ï¼Œæ‚¨å¯ä»¥ä¾¿æ·åœ°å‘èµ·ä»»åŠ¡ã€è·å–ä»»åŠ¡å®æ—¶è¿›åº¦ï¼ˆåŒ…æ‹¬æ€»è¿›åº¦ã€å½“å‰æ‰§è¡ŒèŠ‚ç‚¹åŠèŠ‚ç‚¹å†…è¿›åº¦ï¼‰ï¼Œå¹¶åœ¨ä»»åŠ¡å®Œæˆåè·å–ç»“æœä¿¡æ¯ã€‚

## äºŒã€ç¯å¢ƒå‡†å¤‡

### 1. è¿è¡Œç¯å¢ƒè¦æ±‚

- Python ç‰ˆæœ¬ï¼šPython 3.6 åŠä»¥ä¸Š
- ä¾èµ–åº“ï¼šéœ€è¦å®‰è£…ä»¥ä¸‹ Python åº“ï¼ˆå·¥å…·è¿è¡Œä¾èµ–ï¼‰

### 2. ä¾èµ–å®‰è£…

æ‰“å¼€ç»ˆç«¯ï¼ˆå‘½ä»¤æç¤ºç¬¦ / CMDï¼‰ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…ä¾èµ–ï¼š

```bash
pip install requests websocket-client
```

## ä¸‰ã€é…ç½®è¯´æ˜

ä½¿ç”¨å‰éœ€å…ˆé…ç½®å·¥å…·ä¸­çš„å…³é”®å‚æ•°ï¼ˆä½äºä»£ç æ–‡ä»¶å¤´éƒ¨ï¼‰ï¼Œè¿™äº›å‚æ•°ç”¨äºä¸ Runninghub å¹³å°äº¤äº’ï¼Œå¿…é¡»æ­£ç¡®å¡«å†™ã€‚

### 1. æ ¸å¿ƒé…ç½®å‚æ•°

| å‚æ•°å        | è¯´æ˜                                                  |
| ------------- | ----------------------------------------------------- |
| `API_KEY`     | ç”¨äºèº«ä»½éªŒè¯çš„å¯†é’¥ï¼ŒRunninghub å¹³å°è¯†åˆ«ç”¨æˆ·èº«ä»½çš„å‡­è¯ |
| `WORKFLOW_ID` | æ‚¨è¦è¿è¡Œçš„ ComfyUI å·¥ä½œæµ IDï¼ŒæŒ‡å®šéœ€è¦æ‰§è¡Œçš„å·¥ä½œæµ    |

**API_KEYè·å–æ–¹å¼ï¼š**

1.ç‚¹å‡»APIè°ƒç”¨æ ï¼Œåˆ°å¦‚å›¾ç•Œé¢ï¼Œç‚¹å‡»è¿›å…¥æ§åˆ¶å°

![image-20251021171143375.png](https://api.apifox.com/api/v1/projects/6103976/resources/583381/image-preview)

2.ç‚¹å‡»å¤åˆ¶

![image-20251021171246178.png](https://api.apifox.com/api/v1/projects/6103976/resources/583382/image-preview)


**WORKFLOW_IDè·å–æ–¹å¼ï¼š**ï¼ˆæœ¬ä¾‹å­ä»¥ä¸»é¡µä¸­çš„å·¥ä½œæµä¸ºä¾‹ï¼‰

1.ç‚¹å‡»å·¥ä½œæµ

2.è¿›å…¥å¦‚å›¾ç•Œé¢ï¼Œä¸Šæ–¹åœ°å€æ ä¸­çš„`https://www.runninghub.ai/post/1980214445693689857`åé¢ä¸€ä¸²æ•°å­—ï¼š`1980214445693689857`å³ä¸ºWORKFLOW_IDï¼ˆå·¥ä½œæµidï¼‰ã€‚


![image.png](https://api.apifox.com/api/v1/projects/6103976/resources/583974/image-preview)


### 2. é…ç½®æ­¥éª¤

1. ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚ VS Codeã€è®°äº‹æœ¬ç­‰ï¼‰æ‰“å¼€ ä¸‹è½½å¥½çš„è„šæœ¬æ–‡ä»¶ï¼ˆåœ¨æ–‡æœ«é™„æœ‰ï¼‰

2. æ‰¾åˆ°ä»£ç å¤´éƒ¨çš„é…ç½®åŒºåŸŸï¼š

   ```python
   API_KEY = "****************************"  # æ›¿æ¢ä¸ºç”¨æˆ·è‡ªå·±çš„API_KEY
   WORKFLOW_ID = "*****************"  # å¡«å…¥å·¥ä½œæµid
   ```

3. å°† `API_KEY` å’Œ `WORKFLOW_ID` çš„å€¼æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å®é™…ä¿¡æ¯ï¼ˆåˆ é™¤åŸç¤ºä¾‹å€¼ï¼Œå¡«å…¥æ‚¨çš„å¯†é’¥å’Œå·¥ä½œæµ IDï¼‰

## å››ã€ä½¿ç”¨æ­¥éª¤

### 1. åŸºç¡€ä½¿ç”¨ï¼ˆé»˜è®¤å‚æ•°ï¼‰

å¦‚æœæ‚¨ä¸éœ€è¦è‡ªå®šä¹‰ä»»åŠ¡å‚æ•°ï¼ˆä½¿ç”¨å·¥ä½œæµé»˜è®¤é…ç½®ï¼‰ï¼Œç›´æ¥è¿è¡Œå³å¯ï¼š

1. åœ¨æœ€åçš„å®Œæ•´ç¤ºä¾‹ä¸­å¤åˆ¶ä»£ç ï¼Œä¿å­˜åˆ°æœ¬åœ°å‘½åä¸º`xxxx.py`ï¼ˆè‡ªå®šä¹‰å‘½åå³å¯ï¼‰

2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥æ–‡ä»¶æ‰€åœ¨ç›®å½•

3. æ‰§è¡Œå‘½ä»¤å¯åŠ¨å·¥å…·ï¼š

   ```bash
   python xxxx.py
   ```

### 2. è‡ªå®šä¹‰ä»»åŠ¡å‚æ•°ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å‘å·¥ä½œæµä¼ é€’è‡ªå®šä¹‰å‚æ•°ï¼ˆå¦‚è¾“å…¥å›¾ç‰‡ã€æ–‡æœ¬ç­‰ï¼‰ï¼Œéœ€ä¿®æ”¹ `node_info_list` å‚æ•°ï¼š

1. åœ¨ä»£ç ä¸­æ‰¾åˆ° `main` å‡½æ•°ä¸­çš„ `node_info_list` å®šä¹‰ï¼š

   ```python
   # 1. å‘èµ·ä»»åŠ¡+è·å–WSS
   # node_info_listé»˜è®¤ä¸ºç©º
   node_info_list = '[]'
   ```

2. æŒ‰ç…§ Runninghub å¹³å°çš„å·¥ä½œæµå‚æ•°æ ¼å¼ï¼Œå¡«å†™è‡ªå®šä¹‰å‚æ•°ï¼ˆéœ€ä¸º JSON å­—ç¬¦ä¸²æ ¼å¼ï¼‰ã€‚ä¾‹å¦‚ï¼š

   ```python
   node_info_list = '[{"nodeId": "6","fieldName": "text",  "fieldValue": "Depth of field, blurry street background,photo of a cyberpunk barbarian Battlecore woman with glowing opalescent third eye,bust, highly detailed glowing Elvish runes tattooed to the irises, glowing Elvish, Stealth Skin, runes on cheeks, runes on jaw line, runes on ears, runes on forehead,",  "description": "text"}]'
   ```

   ï¼ˆæ³¨ï¼šå…·ä½“å‚æ•°æ ¼å¼éœ€å‚è€ƒæ‚¨çš„å·¥ä½œæµèŠ‚ç‚¹è¦æ±‚ï¼Œå¯åœ¨ Runninghub å·¥ä½œæµç¼–è¾‘é¡µé¢æŸ¥çœ‹èŠ‚ç‚¹å‚æ•°è¯´æ˜ï¼‰

3. ä¿å­˜æ–‡ä»¶åï¼ŒæŒ‰ç…§ã€ŒåŸºç¡€ä½¿ç”¨ã€æ­¥éª¤è¿è¡Œå·¥å…·

## äº”ã€åŠŸèƒ½è¯´æ˜

å·¥å…·è¿è¡Œè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼Œæ‚¨å¯é€šè¿‡ç»ˆç«¯è¾“å‡ºäº†è§£å®æ—¶çŠ¶æ€ï¼š

### 1. ä»»åŠ¡å‘èµ·ä¸ WSS è·å–

- å·¥å…·é¦–å…ˆå‘ Runninghub å¹³å°å‘èµ·ä»»åŠ¡è¯·æ±‚ï¼Œè·å– `taskId`ï¼ˆä»»åŠ¡å”¯ä¸€æ ‡è¯†ï¼‰
- å‘èµ·æˆåŠŸåï¼Œç”±äºRunningHubå¹³å°éœ€è¦æ’é˜Ÿï¼Œæ­¤æ—¶å·¥å…·ä¼šè½®è¯¢å¹³å°è·å– WSS é“¾æ¥ï¼ˆç”¨äºå®æ—¶ç›‘æ§è¿›åº¦ï¼‰ï¼š
  - è‹¥ä»»åŠ¡å·²å¿«é€Ÿå®Œæˆï¼Œä¼šç›´æ¥è¾“å‡ºç»“æœï¼ˆæ–‡ä»¶ç±»å‹å’Œ URLï¼‰
  - è‹¥ä»»åŠ¡éœ€è¦æ‰§è¡Œä¸€æ®µæ—¶é—´ï¼Œä¼šè·å– WSS é“¾æ¥å¹¶å¯åŠ¨è¿›åº¦ç›‘æ§

### 2. èŠ‚ç‚¹æ˜ å°„è·å–

å·¥å…·ä¼šè‡ªåŠ¨è·å–å·¥ä½œæµä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ ID ä¸åç§°æ˜ å°„å…³ç³»ï¼Œç”¨äºåœ¨è¿›åº¦ä¸­æ˜¾ç¤ºèŠ‚ç‚¹åç§°ï¼ˆè€Œéæ™¦æ¶©çš„ IDï¼‰ï¼Œè¾“å‡ºç±»ä¼¼ï¼š

```plaintext
âœ… èŠ‚ç‚¹æ˜ å°„è·å–æˆåŠŸï¼ˆå…±7ä¸ªèŠ‚ç‚¹ï¼‰, åˆ†åˆ«æ˜¯{'3': 'KSampler', '4': 'CheckpointLoaderSimple', '5': 'EmptyLatentImage', '6': 'CLIPTextEncode', '7': 'CLIPTextEncode', '8': 'VAEDecode', '9': 'SaveImage'}
```

### 3. è¿›åº¦ç›‘æ§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

é€šè¿‡ WebSocket å®æ—¶æ¥æ”¶è¿›åº¦ä¿¡æ¯ï¼Œç»ˆç«¯ä¼šåŠ¨æ€è¾“å‡ºä»¥ä¸‹å†…å®¹ï¼š

- æ€»è¿›åº¦ï¼šå·²å®ŒæˆèŠ‚ç‚¹æ•° / æ€»èŠ‚ç‚¹æ•°çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š`æ€»è¿›åº¦: 30.0% (3/10)`ï¼‰
- å½“å‰èŠ‚ç‚¹ï¼šæ­£åœ¨æ‰§è¡Œçš„èŠ‚ç‚¹åç§°ï¼ˆä¾‹å¦‚ï¼š`å½“å‰èŠ‚ç‚¹: Upscale`ï¼‰
- èŠ‚ç‚¹å†…è¿›åº¦ï¼šå½“å‰èŠ‚ç‚¹çš„æ‰§è¡Œè¿›åº¦ï¼ˆä¾‹å¦‚ï¼š`(50.0%)`ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²å®Œæˆä¸€åŠï¼‰
- ç‰¹æ®ŠçŠ¶æ€æç¤ºï¼š
  - ç¼“å­˜èŠ‚ç‚¹å®Œæˆï¼š`ğŸ“Œ èŠ‚ç‚¹Resizeï¼ˆç¼“å­˜å®Œæˆï¼‰`ï¼ˆè¡¨ç¤ºè¯¥èŠ‚ç‚¹ä½¿ç”¨ç¼“å­˜ç»“æœï¼Œæ— éœ€é‡æ–°æ‰§è¡Œï¼‰
  - ä»»åŠ¡å®Œæˆï¼š`ğŸ‰ ä»»åŠ¡å®Œæˆï¼`ï¼ˆæ­¤æ—¶ä¼šè‡ªåŠ¨å…³é—­ç›‘æ§ï¼‰

## å…­ã€è¾“å‡ºä¿¡æ¯è§£è¯»

| è¾“å‡ºç¤ºä¾‹                                             | å«ä¹‰è¯´æ˜                                                     |
| ---------------------------------------------------- | ------------------------------------------------------------ |
| `âœ… ä»»åŠ¡å‘èµ·æˆåŠŸï¼ŒtaskId: 123456`                     | ä»»åŠ¡å·²æˆåŠŸæäº¤åˆ° Runninghub å¹³å°ï¼Œ`taskId` æ˜¯è¯¥ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯† |
| `ğŸ” ç¬¬3æ¬¡è½®è¯¢...`                                     | æ­£åœ¨è½®è¯¢å¹³å°è·å– WSS é“¾æ¥ï¼ˆæœ€å¤šè½®è¯¢ 30 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 5 ç§’ï¼‰   |
| `âœ… è·å–WSSæˆåŠŸï¼šwss://xxx`                           | å·²è·å–åˆ°å®æ—¶ç›‘æ§é“¾æ¥ï¼Œå³å°†å¯åŠ¨è¿›åº¦ç›‘æ§                       |
| `ğŸ“Š è¿›åº¦ç›‘æ§å·²å¯åŠ¨...`                                | WebSocket è¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹æ¥æ”¶è¿›åº¦ä¿¡æ¯                       |
| `ğŸ“ˆ æ€»è¿›åº¦: 50.0% (5/10) - å½“å‰èŠ‚ç‚¹: Upscale (75.0%)` | æ€»è¿›åº¦ 50%ï¼ˆ10 ä¸ªèŠ‚ç‚¹å®Œæˆ 5 ä¸ªï¼‰ï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œã€ŒUpscaleã€èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹å·²å®Œæˆ 75% |
| `ğŸ“Œ èŠ‚ç‚¹LoadImageï¼ˆç¼“å­˜å®Œæˆï¼‰`                        | ã€ŒLoadImageã€èŠ‚ç‚¹ä½¿ç”¨ç¼“å­˜ç»“æœï¼Œå·²æ ‡è®°ä¸ºå®Œæˆ                  |
| `ğŸ‰ ä»»åŠ¡å®Œæˆï¼`                                       | æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆï¼Œä»»åŠ¡ç»“æŸ                                   |

## ä¸ƒã€å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ³•

| é—®é¢˜ç°è±¡                                 | å¯èƒ½åŸå› åŠè§£å†³æ–¹æ³•                                           |
| ---------------------------------------- | ------------------------------------------------------------ |
| ä»»åŠ¡å‘èµ·å¼‚å¸¸ï¼Œæç¤º â€œä»»åŠ¡å‘èµ·å¼‚å¸¸ï¼š{...}â€ | 1. `API_KEY` é”™è¯¯ï¼šæ£€æŸ¥ API å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼ˆæ³¨æ„æ˜¯å¦æœ‰ç©ºæ ¼ã€å¤§å°å†™é”™è¯¯ï¼‰<br />2. `WORKFLOW_ID` é”™è¯¯ï¼šç¡®è®¤å·¥ä½œæµ ID æ˜¯å¦å­˜åœ¨ |
| è½®è¯¢è¶…æ—¶ï¼Œæç¤º â€œâŒ è½®è¯¢è¶…æ—¶ï¼Œæœªè·å– WSSâ€  | 1. å¹³å°å¤„ç†ä»»åŠ¡è¿‡æ…¢ï¼šå¯å°è¯•é‡æ–°è¿è¡Œå·¥å…·<br />2. ç½‘ç»œé—®é¢˜ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œèƒ½å¦è®¿é—® Runninghub å¹³å°<br />3.æ’é˜Ÿè¿‡ä¹…ï¼šåœ¨Runninghubä¸Šå‘èµ·ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦ä¸€ç›´æ’é˜Ÿï¼Œåªæœ‰æ’é˜ŸæˆåŠŸå¤„äºè¿è¡ŒçŠ¶æ€æ—¶æ‰èƒ½è·å–åˆ°WebSocketé“¾æ¥ã€‚ |
| ç›´æ¥è¾“å‡ºä»»åŠ¡ç”Ÿæˆç»“æœï¼Œæ²¡æœ‰ä»»åŠ¡è¿›åº¦æ˜¾ç¤º   | æœ¬è„šæœ¬è½®è¯¢RunningHubçš„æ—¶é—´é—´éš”æ˜¯5sï¼Œè¯´æ˜5så†…ä»»åŠ¡ä»æ’é˜Ÿåˆ°æ‰§è¡Œå®Œäº†ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡è½®è¯¢ç”Ÿæˆç»“æœç›´æ¥è¿”å›ç»“æœã€‚ |
| è¿›åº¦æ˜¾ç¤ºèŠ‚ç‚¹ ID è€Œéåç§°                 | èŠ‚ç‚¹æ˜ å°„è·å–å¤±è´¥ï¼Œå¯å¿½ç•¥ï¼ˆä¸å½±å“ä»»åŠ¡æ‰§è¡Œï¼‰ï¼Œæˆ–é‡æ–°è¿è¡Œå·¥å…·è·å–æ˜ å°„ |

## å…«ã€æ³¨æ„äº‹é¡¹

1. è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ `API_KEY`ï¼Œé¿å…æ³„éœ²ç»™ä»–äººï¼ˆå¯èƒ½å¯¼è‡´ä»–äººæ»¥ç”¨æ‚¨çš„å¹³å°èµ„æºï¼‰
2. è‹¥ä»»åŠ¡é•¿æ—¶é—´æ— è¿›åº¦æ›´æ–°ï¼ˆè¶…è¿‡ 10 åˆ†é’Ÿï¼‰ï¼Œå¯ç»ˆæ­¢å·¥å…·å¹¶é‡æ–°å‘èµ·ä»»åŠ¡
3. ä»»åŠ¡å®Œæˆåï¼Œç»“æœæ–‡ä»¶ URL ä¼šæ˜¾ç¤ºåœ¨ç»ˆç«¯ä¸­ï¼Œå¯ç›´æ¥è®¿é—®ä¸‹è½½ï¼ˆURL æœ‰æ•ˆæœŸä»¥å¹³å°è§„åˆ™ä¸ºå‡†ï¼‰
4. è‡ªå®šä¹‰ `node_info_list` æ—¶ï¼Œéœ€ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ï¼ˆå¯ä½¿ç”¨åœ¨çº¿ JSON æ ¡éªŒå·¥å…·éªŒè¯ï¼‰

## è„šæœ¬å®Œæ•´ç¤ºä¾‹

```python
import requests
import json
import time
from websocket import WebSocketApp
from typing import Dict, Set, Optional

# é…ç½®
API_KEY = "****************************"  # æ›¿æ¢ä¸ºç”¨æˆ·è‡ªå·±çš„API_KEY
WORKFLOW_ID = "*****************"  # å¡«å…¥å·¥ä½œæµid
HEADERS = {"Host": "www.runninghub.cn", "Content-Type": "application/json"}
URLS = {
    "create_task": "https://www.runninghub.cn/task/openapi/create",
    "get_outputs": "https://www.runninghub.cn/task/openapi/outputs",
    "get_nodes": "https://www.runninghub.cn/api/openapi/getJsonApiFormat"
}


def get_task_results(task_id: str, max_retries: int = 3):
    """è·å–ä»»åŠ¡ç»“æœï¼Œå¸¦é‡è¯•æœºåˆ¶"""
    for attempt in range(max_retries):
        try:
            resp = requests.post(
                URLS["get_outputs"],
                headers=HEADERS,
                data=json.dumps({"apiKey": API_KEY, "taskId": task_id})
            )
            resp.raise_for_status()

            data = resp.json().get("data")

            if isinstance(data, list) and data:
                print("\nğŸ“„ ç”Ÿæˆç»“æœï¼š")
                for i, item in enumerate(data, 1):
                    print(f"  ç»“æœ{i}ï¼šç±»å‹={item.get('fileType', 'æœªçŸ¥')}ï¼ŒURL={item.get('fileUrl', 'æœªçŸ¥')}")
                return True

            # ç­‰å¾…åé‡è¯•
            if attempt < max_retries - 1:
                print("â³ ç»“æœæœªå°±ç»ªï¼Œç­‰å¾…5ç§’åé‡è¯•...")
                time.sleep(5)

        except Exception as e:
            print(f"âŒ è·å–ç»“æœå¼‚å¸¸ï¼š{str(e)}")
            if attempt < max_retries - 1:
                print("â³ ç­‰å¾…5ç§’åé‡è¯•...")
                time.sleep(5)

    print("âŒ æ‰€æœ‰é‡è¯•å°è¯•å‡å¤±è´¥ï¼Œæœªæ‰¾åˆ°ç”Ÿæˆç»“æœ")
    return False


class ProgressInfo:
    def __init__(self):
        self.completed_nodes: Set[str] = set()
        self.current_node: str = ""
        self.current_node_name: str = ""
        self.current_progress: int = 0
        self.current_max: int = 0
        self.id_to_class_type: Optional[Dict[str, str]] = None

    def set_id_to_class_type(self, id_map: Dict[str, str]):
        self.id_to_class_type = id_map

    def set_current_node(self, node_id: str):
        self.current_node = node_id
        self.current_node_name = self.id_to_class_type.get(node_id, "") if (self.id_to_class_type and node_id) else ""

    def add_completed_node(self, node_id: str) -> bool:
        if node_id not in self.completed_nodes:
            self.completed_nodes.add(node_id)
            return True
        return False

    def clear_current_node(self):
        self.current_node = self.current_node_name = ""
        self.current_progress = self.current_max = 0

    def get_overall_percent(self) -> float:
        total = len(self.id_to_class_type) if self.id_to_class_type else 0
        return (len(self.completed_nodes) / total) * 100 if total > 0 else 0.0

    def get_current_node_percent(self) -> float:
        return (self.current_progress / self.current_max) * 100 if self.current_max > 0 else 0.0

    def __str__(self):
        base = f"æ€»è¿›åº¦: {self.get_overall_percent():.1f}% ({len(self.completed_nodes)}/{len(self.id_to_class_type) if self.id_to_class_type else 0})"
        if self.current_node_name:
            base += f" - å½“å‰èŠ‚ç‚¹: {self.current_node_name}"
        if self.current_max > 0:
            base += f" ({self.get_current_node_percent():.1f}%)"
        return base


def create_task_and_get_wss(node_info_list: str) -> tuple:
    """å‘èµ·ComfyUIä»»åŠ¡ï¼Œè½®è¯¢è·å–WSSé“¾æ¥å’ŒtaskId"""
    node_info_list = node_info_list.strip()
    try:
        resp = requests.post(
            URLS["create_task"],
            headers=HEADERS,
            data=json.dumps({
                "apiKey": API_KEY,
                "workflowId": WORKFLOW_ID,
                "nodeInfoList": json.loads(node_info_list)
            })
        )
        resp.raise_for_status()
        task_id = resp.json().get("data", {}).get("taskId")
        if not task_id:
            print(f"ä»»åŠ¡å‘èµ·å¤±è´¥ï¼š{resp.json()}")
            return None, None
        print(f"âœ… ä»»åŠ¡å‘èµ·æˆåŠŸï¼ŒtaskId: {task_id}")

    except Exception as e:
        print(f"ä»»åŠ¡å‘èµ·å¼‚å¸¸ï¼š{str(e)}")
        return None, None

    # è½®è¯¢è·å–WSS
    for poll_cnt in range(1, 31):
        print(f"ğŸ” ç¬¬{poll_cnt}æ¬¡è½®è¯¢è·å–WSS...")
        time.sleep(5)

        try:
            resp = requests.post(
                URLS["get_outputs"],
                headers=HEADERS,
                data=json.dumps({"apiKey": API_KEY, "taskId": task_id})
            )
            resp.raise_for_status()
            data = resp.json().get("data")

            # ç›´æ¥è¿”å›ç»“æœ
            if isinstance(data, list):
                print("\nğŸ‰ ä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥è·å–ç»“æœï¼š")
                if data:
                    for i, item in enumerate(data, 1):
                        print(f"  ç»“æœ{i}ï¼šç±»å‹={item.get('fileType', 'æœªçŸ¥')}ï¼ŒURL={item.get('fileUrl', 'æœªçŸ¥')}")
                return None, task_id

            # æå–WSS
            if isinstance(data, dict):
                wss_url = data.get("netWssUrl")
                if wss_url:
                    print(f"âœ… è·å–WSSæˆåŠŸï¼š{wss_url}")
                    return wss_url, task_id

            print("WSSæœªå°±ç»ªï¼Œç»§ç»­ç­‰å¾…...")

        except Exception as e:
            print(f"è½®è¯¢å¼‚å¸¸ï¼š{str(e)}")

    print("âŒ è½®è¯¢è¶…æ—¶ï¼Œæœªè·å–WSS")
    return None, task_id


def get_node_id_name_map() -> Dict[str, str]:
    """è·å–èŠ‚ç‚¹IDâ†’åç§°æ˜ å°„"""
    try:
        resp = requests.post(
            URLS["get_nodes"],
            headers=HEADERS,
            data=json.dumps({"apiKey": API_KEY, "workflowId": WORKFLOW_ID})
        )
        resp.raise_for_status()
        prompt_json = resp.json().get("data", {}).get("prompt", "{}")
        id_name_map = {
            node_id: info.get("class_type", node_id)
            for node_id, info in json.loads(prompt_json).items()
        }
        print(f"âœ… èŠ‚ç‚¹æ˜ å°„è·å–æˆåŠŸï¼ˆå…±{len(id_name_map)}ä¸ªèŠ‚ç‚¹ï¼‰, åˆ†åˆ«æ˜¯{id_name_map}")
        return id_name_map
    except Exception as e:
        print(f"èŠ‚ç‚¹æ˜ å°„è·å–å¼‚å¸¸ï¼š{str(e)}")
        return {}


class TaskProgressMonitor:
    def __init__(self, task_id: str):
        self.progress = ProgressInfo()
        self.tmp_node: Optional[str] = None
        self.task_id = task_id

    def start_monitor(self, wss_url: str, node_id_name_map: Dict[str, str]):
        self.progress.set_id_to_class_type(node_id_name_map)

        def on_open(ws):
            print("\nğŸ“Š è¿›åº¦ç›‘æ§å·²å¯åŠ¨...")

        def on_message(ws, msg):
            try:
                data = json.loads(msg)
                msg_type = data.get("type", "")

                if msg_type == "progress":
                    d = data.get("data", {})
                    self.progress.set_current_node(d.get("node", ""))
                    self.progress.current_progress = d.get("value", 0)
                    self.progress.current_max = d.get("max", 0)
                    print(f"ğŸ“ˆ {self.progress}")

                elif msg_type == "executing":
                    if self.tmp_node:
                        self.progress.add_completed_node(self.tmp_node)
                        self.progress.clear_current_node()
                    self.tmp_node = data.get("data", {}).get("node", "")
                    if self.tmp_node:
                        self.progress.set_current_node(self.tmp_node)
                        print(f"ğŸ“ˆ {self.progress}")

                elif msg_type == "execution_cached":
                    for node_id in data.get("data", {}).get("nodes", []):
                        if node_id and self.progress.add_completed_node(node_id):
                            print(f"ğŸ“Œ èŠ‚ç‚¹{node_id_name_map.get(node_id, node_id)}ï¼ˆç¼“å­˜å®Œæˆï¼‰")
                    print(f"ğŸ“ˆ {self.progress}")

                elif msg_type == "execution_success":
                    if self.tmp_node:
                        self.progress.add_completed_node(self.tmp_node)
                    print(f"ğŸ“ˆ {self.progress}\nğŸ‰ ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ­£åœ¨è·å–ç”Ÿæˆç»“æœ...")

                    if get_task_results(self.task_id):
                        print("âœ… æ‰€æœ‰ç»“æœè·å–å®Œæˆï¼")
                    ws.close()

            except Exception as e:
                print(f"âŒ æ¶ˆæ¯å¤„ç†å¼‚å¸¸ï¼š{str(e)}")

        def on_close(ws, code, reason):
            reason_str = reason.decode() if isinstance(reason, bytes) else reason
            print(f"\nğŸ”Œ ç›‘æ§å…³é—­ï¼š{reason_str}ï¼ˆçŠ¶æ€ç ï¼š{code}ï¼‰")

        def on_error(ws, err):
            print(f"âŒ ç›‘æ§é”™è¯¯ï¼š{str(err)}")

        WebSocketApp(wss_url, on_open=on_open, on_message=on_message, on_close=on_close,
                     on_error=on_error).run_forever()


def main():
    # å‘èµ·ä»»åŠ¡
    node_info_list = '[]'
    wss_url, task_id = create_task_and_get_wss(node_info_list)

    # å¦‚æœç›´æ¥è¿”å›ç»“æœï¼Œåˆ™æ— éœ€ç›‘æ§
    if not wss_url:
        return

    # è·å–èŠ‚ç‚¹æ˜ å°„å¹¶å¯åŠ¨ç›‘æ§
    node_map = get_node_id_name_map()
    print("\n=== å¯åŠ¨è¿›åº¦ç›‘æ§ ===")
    TaskProgressMonitor(task_id).start_monitor(wss_url, node_map)


if __name__ == "__main__":
    main()
```
